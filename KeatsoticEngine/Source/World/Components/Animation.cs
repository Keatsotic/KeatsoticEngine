using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using Microsoft.Xna.Framework;
using Microsoft.Xna.Framework.Graphics;
using MonoGame.Extended.TextureAtlases;
using MonoGame.Extended.Animations;
using MonoGame.Extended.Animations.SpriteSheets;
using KeatsoticEngine.Source.Data;
using MonoGame.Extended.Sprites;

namespace KeatsoticEngine.Source.World.Components
{
	class Animation : Component
	{
		public override ComponentType ComponentType => ComponentType.Animation;

		public Rectangle TextureRectangle{ get; set; }
		public State CurrentState { get; set; }
		public bool AnimationFinished { get; private set; }
		private double _counter;
		public readonly AnimatedSprite objectAnimated;
		public readonly Sprite objectSprite;


		public Animation(Texture2D texture, SpriteSheetData spriteSheetData, int direction = 0, bool isPlayer = false)
		{
			var spriteWidth = spriteSheetData.Width;
			var spriteHeight = spriteSheetData.Height;
			var objectTexture = texture;
			var objectAtlas = TextureAtlas.Create("objectAtlas", objectTexture, spriteWidth, spriteHeight);

			var animationFactory = new SpriteSheetAnimationFactory(objectAtlas);
			for (int i = 0; i < spriteSheetData.AnimationName.Count; i++)
			{
				animationFactory.Add(spriteSheetData.AnimationName[i], new SpriteSheetAnimationData(spriteSheetData.FrameArray[i], spriteSheetData.FrameDuration[i], spriteSheetData.IsLooping[i]));
			}

			if (isPlayer)
			{
				objectAnimated = new AnimatedSprite(animationFactory, HUD.PlayerCurrentState.ToString());
			}
			else
			{
				objectAnimated = new AnimatedSprite(animationFactory, "Idle");
			}

			objectSprite = objectAnimated;
			objectSprite.Origin = Vector2.Zero;

			if (direction == (int)Direction.Right)
			{
				objectAnimated.Effect = SpriteEffects.None;
			} else {
				objectAnimated.Effect = SpriteEffects.FlipHorizontally;
			}
		}
		
		public override void Update(GameTime gameTime)
		{
			AnimationFinished = false;
			var damage = GetComponent<Damage>(ComponentType.Damage);

			_counter += gameTime.ElapsedGameTime.TotalMilliseconds;

			if (_counter > 50)
			{
				if (CurrentState.ToString().Contains("Attack") || CurrentState.ToString().Contains("Hurt") || CurrentState.ToString().Contains("Special"))
				{
					objectAnimated.Play(CurrentState.ToString(), () => AnimationFinished = true);
				}
				else
				{
					objectAnimated.Play(CurrentState.ToString());
				}

				_counter = 0;

				ChangeDirection();
			}

			objectAnimated.Update(gameTime);
			
			//flash sprite when hurt
			if (damage == null)
				return;
			if (damage.IsInvincible)
			{
				if (_counter % 2 == 0)
				{
					objectSprite.Color = new Color(0, 0, 0, 0);
				}
				else
				{
					objectSprite.Color = Color.White;
				}
			}
			else
			{
				objectSprite.Color = Color.White;
			}
		}

		public override void Draw(SpriteBatch spriteBatch)
		{
			var transform = GetComponent<Transform>(ComponentType.Transform);
			if (transform == null)
				return;
			objectAnimated.Position = transform.Position;

			spriteBatch.Draw(objectSprite);
		}

		private void ChangeDirection()
		{
			var transform = GetComponent<Transform>(ComponentType.Transform);
			if (transform == null)
				return;

			if (!Game1.SideScroller)
			{
				switch (transform.Direction)
				{
					case Direction.Up:
						break;
					case Direction.Down:
						break;
					case Direction.Left:
						objectAnimated.Effect = SpriteEffects.FlipHorizontally;
						break;
					case Direction.Right:
						objectAnimated.Effect = SpriteEffects.None;
						break;
				}
			}
			else
			{
				switch (transform.Direction)
				{
					case Direction.Right:
						objectAnimated.Effect = SpriteEffects.None;
						break;
					case Direction.Left:
						objectAnimated.Effect = SpriteEffects.FlipHorizontally;
						break;
				}
			}
		}
	}
}
